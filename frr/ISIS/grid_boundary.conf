!
! FRR Configuration - Grid边界路由器 (L1L2)
! 示例: Grid-A R6 (右边界节点)
! 追求快速收敛，启用IETF SPF优化
! 修正版本：解决无直接L2连接节点的路由学习问题
!
frr version 10.0
frr defaults traditional
!
hostname GridA-R6-Boundary
!
! 基础接口配置
interface lo
 ip address 10.1.0.6/32
 ipv6 address 2001:db8:1::6/128
 ip router isis 1
 ipv6 router isis 1
 isis passive
!
! Grid内连接 - L1级别 (连接同Grid的其他L1L2和L1节点)
interface eth0
 description "To GridA-R3 (L1 internal)"
 ip address 10.1.1.6/30
 ipv6 address 2001:db8:1:1::6/64
 ip router isis 1
 ipv6 router isis 1
 isis circuit-type level-1
 isis network point-to-point
 isis hello-interval 1
 isis hello-multiplier 3
 isis csnp-interval 2
 isis psnp-interval 1
 isis metric 10
!
interface eth1
 description "To GridA-R5 (L1 center)"
 ip address 10.1.2.6/30
 ipv6 address 2001:db8:1:2::6/64
 ip router isis 1
 ipv6 router isis 1
 isis circuit-type level-1
 isis network point-to-point
 isis hello-interval 1
 isis hello-multiplier 3
 isis csnp-interval 2
 isis psnp-interval 1
 isis metric 10
!
interface eth2
 description "To GridA-R9 (L1 internal)"
 ip address 10.1.3.6/30
 ipv6 address 2001:db8:1:3::6/64
 ip router isis 1
 ipv6 router isis 1
 isis circuit-type level-1
 isis network point-to-point
 isis hello-interval 1
 isis hello-multiplier 3
 isis csnp-interval 2
 isis psnp-interval 1
 isis metric 10
!
! Grid间连接 - L2级别 (仅有直接L2连接的边界节点配置)
interface eth3
 description "To GridB-R4 (L2 inter-grid direct)"
 ip address 192.168.12.1/30
 ipv6 address 2001:db8:ff:12::1/64
 ip router isis 1
 ipv6 router isis 1
 isis circuit-type level-2-only
 isis network point-to-point
 isis hello-interval 1
 isis hello-multiplier 3
 isis csnp-interval 2
 isis psnp-interval 1
 isis metric 100
!
! Torus连接 (可选备份路径，提供冗余)
interface eth4
 description "To GridD-R4 (L2 torus backup)"
 ip address 192.168.14.1/30
 ipv6 address 2001:db8:ff:14::1/64
 ip router isis 1
 ipv6 router isis 1
 isis circuit-type level-2-only
 isis network point-to-point
 isis hello-interval 2
 isis hello-multiplier 3
 isis csnp-interval 3
 isis psnp-interval 2
 isis metric 200
!
! 注意：没有直接L2连接的边界节点 (如GridA-R2, GridA-R4)
! 不配置eth3和eth4接口，只有Grid内的L1连接
!
! ISIS主配置
router isis 1
 net 49.0001.0000.0000.0006.00
 is-type level-1-2
 metric-style wide

 ! 快速收敛优化
 lsp-gen-interval 1
 lsp-refresh-interval 600
 max-lsp-lifetime 1200
 spf-interval 1 5 50
 spf-delay-ietf init-delay 50 short-delay 50 long-delay 200 holddown 2000 time-to-learn 500

 ! 基础路由重分发
 redistribute ipv4 connected level-1 metric 10
 redistribute ipv4 connected level-2 metric 10
 redistribute ipv6 connected level-1 metric 10
 redistribute ipv6 connected level-2 metric 10

 ! 关键配置：L2到L1路由重分发 (解决无直接L2连接节点的路由学习问题)
 redistribute isis level-2 into level-1 distribute-list L2-TO-L1 metric 200

 ! 路由汇总 (减少L2数据库大小)
 summary-address 10.1.0.0/16 level-2
 summary-address 2001:db8:1::/48 level-2

 ! 默认路由控制 (ATT位自动设置)
 default-information originate level-1 metric 50

 ! ECMP支持
 maximum-paths 4

 ! 快速Hello和邻接检测
 hello-padding

 ! LSP数据库优化
 lsp-mtu 1492

 ! 附加位控制 (确保ATT位正常工作)
 attached-bit send
 no attached-bit receive ignore
!
! L2到L1路由泄露过滤器 (关键配置)
! 允许其他Grid的路由Down-leak到本Grid的L1级别
ip prefix-list L2-TO-L1 seq 5 permit 0.0.0.0/0
ip prefix-list L2-TO-L1 seq 10 permit 10.0.0.0/8 le 24
ip prefix-list L2-TO-L1 seq 15 permit 192.168.0.0/16 le 30
ip prefix-list L2-TO-L1 seq 20 deny 0.0.0.0/0 le 32
!
ipv6 prefix-list L2-TO-L1-v6 seq 5 permit ::/0
ipv6 prefix-list L2-TO-L1-v6 seq 10 permit 2001:db8::/32 le 64
ipv6 prefix-list L2-TO-L1-v6 seq 15 deny ::/0 le 128
!
! Route-map for L2 to L1 redistribution (可选，用于更精细控制)
route-map L2-TO-L1-RMAP permit 10
 match ip address prefix-list L2-TO-L1
 set metric 200
 set tag 100
!
route-map L2-TO-L1-RMAP deny 20
!
! BFD配置 (可选，进一步加速故障检测)
bfd
 peer 192.168.12.2 interface eth3
  detect-multiplier 3
  receive-interval 300
  transmit-interval 300
 !
!
! 接口BFD启用 (仅在L2连接上启用)
interface eth3
 isis bfd
!
interface eth4
 isis bfd
!
! 日志配置
log syslog informational
log facility local4
!
! 监控和调试配置
! 生产环境建议关闭debug，但保留show命令用于监控
! debug isis events
! debug isis route-events
! debug isis spf-events
! debug isis lsp-gen
!
! 关键监控命令 (注释形式记录)
! show isis neighbor                    # 检查邻接关系
! show isis database level-1 detail     # 检查L1 LSP
! show isis database level-2 detail     # 检查L2 LSP
! show isis route level-1               # 检查L1路由
! show isis route level-2               # 检查L2路由
! show ip route isis                    # 检查最终路由表
! show isis spf-delay-ietf              # 检查SPF性能
!
line vty
!
end
